<!-- HTML header for doxygen 1.9.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>executor.master: APIService.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!--
    Removed completely the TITLEAREA because I don't like the loss of space.
    I want the title in the condensed index (tabs) at top of each HTML page.
    The insertion of the title is managed by javascript code in the footer,
    because this code must be executed AFTER the creation of the condensed index.
    Must have this setting to display the condensed index:
    DISABLE_INDEX = NO
-->
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('windows_2_a_p_i_service_8cpp_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">windows/APIService.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="windows_2_a_p_i_service_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*----------------------------------------------------------------------------*/</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">/*                                                                            */</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">/* Copyright (c) 1995, 2004 IBM Corporation. All rights reserved.             */</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">/* Copyright (c) 2005-2009 Rexx Language Association. All rights reserved.    */</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">/*                                                                            */</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">/* This program and the accompanying materials are made available under       */</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">/* the terms of the Common Public License v1.0 which accompanies this         */</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">/* distribution. A copy is also available at the following address:           */</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">/* http://www.ibm.com/developerworks/oss/CPLv1.0.htm                          */</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">/*                                                                            */</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">/* Redistribution and use in source and binary forms, with or                 */</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">/* without modification, are permitted provided that the following            */</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">/* conditions are met:                                                        */</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">/*                                                                            */</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">/* Redistributions of source code must retain the above copyright             */</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">/* notice, this list of conditions and the following disclaimer.              */</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">/* Redistributions in binary form must reproduce the above copyright          */</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">/* notice, this list of conditions and the following disclaimer in            */</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">/* the documentation and/or other materials provided with the distribution.   */</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">/*                                                                            */</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">/* Neither the name of Rexx Language Association nor the names                */</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">/* of its contributors may be used to endorse or promote products             */</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">/* derived from this software without specific prior written permission.      */</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">/*                                                                            */</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">/* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS        */</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">/* &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT          */</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">/* LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS          */</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">/* FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT   */</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment">/* OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,      */</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">/* SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED   */</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">/* TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,        */</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">/* OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY     */</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">/* OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING    */</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">/* NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS         */</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment">/* SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.               */</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">/*                                                                            */</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment">/*----------------------------------------------------------------------------*/</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160; </div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#include &lt;aclapi.h&gt;</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_a_p_i_server_8hpp.html">APIServer.hpp</a>&quot;</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#include &quot;stdio.h&quot;</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160; </div>
<div class="line"><a name="l00043"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">   43</a></span>&#160;<span class="preprocessor">#define SERVICENAME &quot;RXAPI&quot;</span></div>
<div class="line"><a name="l00044"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a28991060ad7eef75ae01f4c3b23c1da6">   44</a></span>&#160;<span class="preprocessor">#define SERVICEDESCRIPTION &quot;%s Service for Open Object Rexx version %d.%d.%d&quot;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160; </div>
<div class="line"><a name="l00046"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#ad281533a525c10171eb5c0151f5b07b8">   46</a></span>&#160;<span class="preprocessor">#define SYNTAX_HELP  &quot;Syntax: rxapi opt [/s]\n\n&quot;</span>     \</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;                     &quot;Where opt is exactly one of:\n&quot; \</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;                     &quot;/i :\tinstall as Service.\n&quot;    \</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;                     &quot;/u :\tuninstall as Service.\n&quot;  \</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;                     &quot;/v :\tshow Version number\n\n&quot;  \</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;                     &quot;The /s (silent) is optional and prevents any messages from displaying.&quot;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160; </div>
<div class="line"><a name="l00053"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a760469f363ac78dbda04c9da73fe3224">   53</a></span>&#160;<span class="preprocessor">#define APP_LOG_KEYNAME  &quot;SYSTEM\\CurrentControlSet\\Services\\EventLog\\Application\\&quot;</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160; </div>
<div class="line"><a name="l00055"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4cac5eb4b9150dfb16b4c3d23108a896f5e">   55</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">enum</span> {<a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4ca6c794638ad6911b18c88b63c66644ccb">installed_state</a>, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4ca3c06b409a56950df36953bbafccae019">running_state</a>, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4cac5eb4b9150dfb16b4c3d23108a896f5e">disabled_state</a>, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4ca39c75059f37cc59c3a334424b03e3255">uninstalled_state</a>} <a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4c">ServiceStateType</a>;</div>
<div class="line"><a name="l00056"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#ac7c596526f9e0fd9e9adbf618e2bf815a71176e3a910ac13880a59b1628147ff6">   56</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">enum</span> {<a class="code" href="windows_2_a_p_i_service_8cpp.html#ac7c596526f9e0fd9e9adbf618e2bf815acb9da7f09e73b1a6eed5000606d2c5bd">Windows_NT</a>, <a class="code" href="windows_2_a_p_i_service_8cpp.html#ac7c596526f9e0fd9e9adbf618e2bf815a71176e3a910ac13880a59b1628147ff6">Windows_2K</a>} <a class="code" href="windows_2_a_p_i_service_8cpp.html#ac7c596526f9e0fd9e9adbf618e2bf815">WindowsVersionType</a>;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160; </div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment">// Prototypes</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="keywordtype">void</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#a29ce16842044705a5b6a8ead236ebf4e">setServiceDACL</a>(SC_HANDLE hService);</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160; </div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="comment">// Globals for Service</span></div>
<div class="line"><a name="l00062"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a32e64ee1e25eb248e6c4f0bfba0a3d77">   62</a></span>&#160;<span class="keyword">static</span> SERVICE_STATUS_HANDLE <a class="code" href="windows_2_a_p_i_service_8cpp.html#a32e64ee1e25eb248e6c4f0bfba0a3d77">m_hServiceStatus</a>;</div>
<div class="line"><a name="l00063"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">   63</a></span>&#160;<span class="keyword">static</span> SERVICE_STATUS <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>;</div>
<div class="line"><a name="l00064"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#abae38490a0892e0d880cf72efb4e0378">   64</a></span>&#160;<span class="keyword">static</span> SERVICE_DESCRIPTION <a class="code" href="windows_2_a_p_i_service_8cpp.html#abae38490a0892e0d880cf72efb4e0378">Info</a>;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160; </div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160; </div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment">/* - - - - Useful debugging help, if&#39;d out under normal circumstances- - - - -*/</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160; </div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="preprocessor">#if 0</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="preprocessor">#include &lt;shlobj.h&gt;</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="preprocessor">#include &lt;shlwapi.h&gt;</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160; </div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;TCHAR fileBuf[MAX_PATH];</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *fileName = NULL;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160; </div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="keywordtype">void</span> __cdecl DebugMsg(<span class="keyword">const</span> <span class="keywordtype">char</span>* pszFormat, ...)</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;{</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  FILE *stream;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  va_list arglist;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  <span class="keywordtype">char</span> buf[1024];</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  sprintf(buf, <span class="stringliteral">&quot;[%s](%lu)(%lu){%d}: &quot;</span>, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>, GetCurrentThreadId(),GetCurrentProcessId(),</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;          <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwCurrentState);</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  va_start(arglist, pszFormat);</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  vsprintf(&amp;buf[strlen(buf)], pszFormat, arglist);</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  va_end(arglist);</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  strcat(buf, <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160; </div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <span class="keywordflow">if</span> ( fileName == NULL )</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  {</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;      SHGetFolderPath(NULL, CSIDL_COMMON_DOCUMENTS | CSIDL_FLAG_CREATE, NULL, 0, fileBuf);</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;      PathAppend(fileBuf, <span class="stringliteral">&quot;apiService.log&quot;</span>);</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;      fileName = fileBuf;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  }</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160; </div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  stream = fopen(fileName, <span class="stringliteral">&quot;a+&quot;</span>);</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  <span class="keywordflow">if</span> ( stream )</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  {</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    fwrite(buf, 1, strlen(buf), stream);</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    fclose(stream);</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  }</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;}</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment">/* - - End debugging help - - - - - - - - - - - - - - - - - - - - - - - - - - */</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160; </div>
<div class="line"><a name="l00105"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#afd6369e26b6811ece83b5818ace1b572">  105</a></span>&#160;<a class="code" href="class_a_p_i_server.html">APIServer</a> <a class="code" href="windows_2_a_p_i_service_8cpp.html#afd6369e26b6811ece83b5818ace1b572">apiServer</a>;             <span class="comment">// the real server instance</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160; </div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment">// A couple of helper functions.</span></div>
<div class="line"><a name="l00108"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#aebee0c998e0babaa2e0ae259b22a9f0f">  108</a></span>&#160;<span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#aebee0c998e0babaa2e0ae259b22a9f0f">showMessage</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *msg, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> icon)</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;{</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    MessageBox(NULL, msg, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>, MB_OK | icon);</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;}</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160; </div>
<div class="line"><a name="l00113"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#acb0f1321940d926d618ec2b3af70403e">  113</a></span>&#160;<span class="preprocessor">#define WINDOWS_95_98_ME  VER_PLATFORM_WIN32_WINDOWS</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160; </div>
<div class="line"><a name="l00115"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#aee50b830b6eba5b46093d05381d9e898">  115</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#aee50b830b6eba5b46093d05381d9e898">isAtLeastVersion</a>(<a class="code" href="windows_2_a_p_i_service_8cpp.html#ac7c596526f9e0fd9e9adbf618e2bf815">WindowsVersionType</a> <a class="code" href="cmdparse_8cpp.html#ac765329451135abec74c45e1897abf26">type</a>)</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;{</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    OSVERSIONINFO <a class="code" href="windows_2_misc_system_8cpp.html#a0433fb1c906371af070782c15cb8e86a">version_info</a>;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="keywordtype">bool</span> answer = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160; </div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <a class="code" href="windows_2_misc_system_8cpp.html#a0433fb1c906371af070782c15cb8e86a">version_info</a>.dwOSVersionInfoSize = <span class="keyword">sizeof</span>(<a class="code" href="windows_2_misc_system_8cpp.html#a0433fb1c906371af070782c15cb8e86a">version_info</a>);</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    GetVersionEx(&amp;<a class="code" href="windows_2_misc_system_8cpp.html#a0433fb1c906371af070782c15cb8e86a">version_info</a>);</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160; </div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="keywordflow">switch</span> ( <a class="code" href="cmdparse_8cpp.html#ac765329451135abec74c45e1897abf26">type</a> )</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    {</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#ac7c596526f9e0fd9e9adbf618e2bf815acb9da7f09e73b1a6eed5000606d2c5bd">Windows_NT</a> :</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;            answer = <a class="code" href="windows_2_misc_system_8cpp.html#a0433fb1c906371af070782c15cb8e86a">version_info</a>.dwPlatformId != <a class="code" href="windows_2_a_p_i_service_8cpp.html#acb0f1321940d926d618ec2b3af70403e">WINDOWS_95_98_ME</a>;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160; </div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#ac7c596526f9e0fd9e9adbf618e2bf815a71176e3a910ac13880a59b1628147ff6">Windows_2K</a> :</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;            answer = <a class="code" href="windows_2_misc_system_8cpp.html#a0433fb1c906371af070782c15cb8e86a">version_info</a>.dwMajorVersion &gt;= 5;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160; </div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        default :</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    }</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    <span class="keywordflow">return</span> answer;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;}</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment"> * Starts up the API server and has it listen for messages.</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment"> * Run() is either called from ServiceMain() in which case the API server will</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment"> * be running in a Service process.  If rxapi is not installed as a service, or</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment"> * for some reason the service can not be started, then Run() is called from</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="comment"> * WinMain() and the API server runs in a standard process.</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="comment"> * @param asService  If true, Run() was called from ServiceMain(), otherwise</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment"> *                   Run() was called from WinMain().</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00150"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a7a0190d9005c22d5b7e4677bf336669e">  150</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#a7a0190d9005c22d5b7e4677bf336669e">Run</a> (<span class="keywordtype">bool</span> asService)</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;{</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    <span class="keywordflow">try</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    {</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#afd6369e26b6811ece83b5818ace1b572">apiServer</a>.<a class="code" href="class_a_p_i_server.html#a4881b9353d97feb93dbd9b08b6153438">initServer</a>();               <span class="comment">// start up the server</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#afd6369e26b6811ece83b5818ace1b572">apiServer</a>.<a class="code" href="class_a_p_i_server.html#a91fbbfde0e42d5d498d03a6911a20d72">listenForConnections</a>();     <span class="comment">// go into the message loop</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    }</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="keywordflow">catch</span> (<a class="code" href="class_service_exception.html">ServiceException</a> *)</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    {</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    }</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#afd6369e26b6811ece83b5818ace1b572">apiServer</a>.<a class="code" href="class_a_p_i_server.html#a5323f78df981e82f09e8428fb300132a">terminateServer</a>();     <span class="comment">// shut everything down</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;}</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="comment"> * The following functions handle the Service control requests.</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160; </div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="comment">// Called when the service is first initialized</span></div>
<div class="line"><a name="l00168"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#aa632f0b3197adeb7777ee5d14a2ac639">  168</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#aa632f0b3197adeb7777ee5d14a2ac639">OnInit</a>()</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;{</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;}</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160; </div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="comment">// Called when the service control manager wants to stop the service</span></div>
<div class="line"><a name="l00174"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#ad671a71077cbdd09d1c7d2379d5a0ef7">  174</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#ad671a71077cbdd09d1c7d2379d5a0ef7">OnStop</a>()</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;{</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#afd6369e26b6811ece83b5818ace1b572">apiServer</a>.<a class="code" href="class_a_p_i_server.html#a5323f78df981e82f09e8428fb300132a">terminateServer</a>();    <span class="comment">// terminate the server.</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;}</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160; </div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="comment">// called when the service is interrogated</span></div>
<div class="line"><a name="l00180"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#aacbfbc2b764a35fa79e6d1ddfea69bba">  180</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#aacbfbc2b764a35fa79e6d1ddfea69bba">OnInterrogate</a>()</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;{</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;}</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160; </div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="comment">// called when the service is paused</span></div>
<div class="line"><a name="l00185"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a7d84071db7709283ccb4bbee75b7e7a9">  185</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#a7d84071db7709283ccb4bbee75b7e7a9">OnPause</a>()</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;{</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;}</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160; </div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment">// called when the service is continued</span></div>
<div class="line"><a name="l00190"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a62266bf9e4b6b83d58e570ce14a1a63e">  190</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#a62266bf9e4b6b83d58e570ce14a1a63e">OnContinue</a>()</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;{</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;}</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160; </div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">// called when the service is shut down</span></div>
<div class="line"><a name="l00195"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a23b0fbb531c015934ac8c77e7e248017">  195</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#a23b0fbb531c015934ac8c77e7e248017">OnShutdown</a>()</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;{</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;}</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160; </div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="comment">// called when the service gets a user control message</span></div>
<div class="line"><a name="l00200"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a1f7a270efc8c68a09857e333c6d0fb07">  200</a></span>&#160;BOOL <a class="code" href="windows_2_a_p_i_service_8cpp.html#a1f7a270efc8c68a09857e333c6d0fb07">OnUserControl</a>(DWORD dwOpcode)</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;{</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="keywordflow">return</span> FALSE; <span class="comment">// say not handled</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;}</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="comment"> * Updates the Service Control Manager with our current state.</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="comment"> * @param dwState  The current state.</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00210"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a6f12d541be60d3ff420ee381789de5c6">  210</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#a6f12d541be60d3ff420ee381789de5c6">SetStatus</a>(DWORD dwState)</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;{</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwCurrentState = dwState;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    SetServiceStatus(<a class="code" href="windows_2_a_p_i_service_8cpp.html#a32e64ee1e25eb248e6c4f0bfba0a3d77">m_hServiceStatus</a>, &amp;<a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>);</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;}</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="comment"> * The handler function registered with the Service Control dispatcher.  The</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment"> * dispatcher uses this function to send service control messages to the service</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="comment"> * process.</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="comment"> * @param dwOpcode  The control message.</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00223"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#acc4c2144e8760df20ff973dff7dbae8d">  223</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> __cdecl <a class="code" href="windows_2_a_p_i_service_8cpp.html#acc4c2144e8760df20ff973dff7dbae8d">Handler</a>(DWORD dwOpcode)</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;{</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="keywordflow">switch</span> (dwOpcode) {</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <span class="keywordflow">case</span> SERVICE_CONTROL_STOP: <span class="comment">// 1</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#a6f12d541be60d3ff420ee381789de5c6">SetStatus</a>(SERVICE_STOP_PENDING);</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#ad671a71077cbdd09d1c7d2379d5a0ef7">OnStop</a>();</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160; </div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <span class="keywordflow">case</span> SERVICE_CONTROL_PAUSE: <span class="comment">// 2</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#a7d84071db7709283ccb4bbee75b7e7a9">OnPause</a>();</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160; </div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <span class="keywordflow">case</span> SERVICE_CONTROL_CONTINUE: <span class="comment">// 3</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#a62266bf9e4b6b83d58e570ce14a1a63e">OnContinue</a>();</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160; </div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="keywordflow">case</span> SERVICE_CONTROL_INTERROGATE: <span class="comment">// 4</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#aacbfbc2b764a35fa79e6d1ddfea69bba">OnInterrogate</a>();</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160; </div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <span class="keywordflow">case</span> SERVICE_CONTROL_SHUTDOWN: <span class="comment">// 5</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#a23b0fbb531c015934ac8c77e7e248017">OnShutdown</a>();</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160; </div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    }</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160; </div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <span class="comment">// Report current status</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    SetServiceStatus(<a class="code" href="windows_2_a_p_i_service_8cpp.html#a32e64ee1e25eb248e6c4f0bfba0a3d77">m_hServiceStatus</a>, &amp;<a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>);</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;}</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160; </div>
<div class="line"><a name="l00255"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a248c764067ee60c03ee370784c49f353">  255</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#a248c764067ee60c03ee370784c49f353">Initialize</a>()</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;{</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="keywordtype">bool</span> result;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160; </div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="comment">// Inform the Service Control Manager that we are about to start.</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a6f12d541be60d3ff420ee381789de5c6">SetStatus</a>(SERVICE_START_PENDING);</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160; </div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="comment">// Perform the actual initialization</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    result = <a class="code" href="windows_2_a_p_i_service_8cpp.html#aa632f0b3197adeb7777ee5d14a2ac639">OnInit</a>();</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160; </div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <span class="comment">// Inform the Service Control Manager of our final state.</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwWin32ExitCode = GetLastError();</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwCheckPoint = 0;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwWaitHint = 0;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160; </div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    <span class="keywordflow">if</span> ( ! result )</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    {</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#a6f12d541be60d3ff420ee381789de5c6">SetStatus</a>(SERVICE_STOPPED);</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    }</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a6f12d541be60d3ff420ee381789de5c6">SetStatus</a>(SERVICE_RUNNING);</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;}</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="comment"> * After the service control dislpatcher receives a start request, (see</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="comment"> * startTheService(),) it creates a new thread and invokes this function on that</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment"> * thread to do the actual work of the service.</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment"> * @param dwArgc    Count of args  (not used by rxapi)</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment"> * @param lpszArgv  Args           (not used by rxapi)</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00287"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a9d2fd619d19d31b6390ee3e6bbc1afcc">  287</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> WINAPI <a class="code" href="windows_2_a_p_i_service_8cpp.html#a9d2fd619d19d31b6390ee3e6bbc1afcc">ServiceMain</a>(DWORD dwArgc, LPTSTR* lpszArgv)</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;{</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    <span class="comment">// Register the handler.  The Service Control Manager will call back to this</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    <span class="comment">// function to issue control requests.</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwCurrentState = SERVICE_START_PENDING;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a32e64ee1e25eb248e6c4f0bfba0a3d77">m_hServiceStatus</a> = RegisterServiceCtrlHandler(<a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>, (LPHANDLER_FUNCTION)<a class="code" href="windows_2_a_p_i_service_8cpp.html#acc4c2144e8760df20ff973dff7dbae8d">Handler</a>);</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="windows_2_a_p_i_service_8cpp.html#a32e64ee1e25eb248e6c4f0bfba0a3d77">m_hServiceStatus</a> ==  (SERVICE_STATUS_HANDLE)NULL )</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    {</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    }</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160; </div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    <span class="comment">// Start the initialisation</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="windows_2_a_p_i_service_8cpp.html#a248c764067ee60c03ee370784c49f353">Initialize</a>() )</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    {</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        <span class="comment">// Do the actual work.  When the Run function returns, the service has</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        <span class="comment">// stopped.</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwWin32ExitCode = 0;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwCheckPoint = 0;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwWaitHint = 0;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160; </div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#a7a0190d9005c22d5b7e4677bf336669e">Run</a>(<span class="keyword">true</span>);</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    }</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160; </div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    <span class="comment">// Tell the service control manager we have stopped</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a6f12d541be60d3ff420ee381789de5c6">SetStatus</a>(SERVICE_STOPPED);</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;}</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="comment"> * Connects the main thread of this service process to the Service Control</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="comment"> * Manager.  When this function succeeds, it will not return until the rxapi</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="comment"> * Service is stopped.</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment"> * @return A return of true indicates that rxapi was successfully started as a</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment"> *         service process and has run to completion.  A return of false</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="comment"> *         indicates the rxapi service process was not started.</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="comment"> * @note   When rxapi is installed as a service, it can not run as a service</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="comment"> *         process unless it is started through the Service Control Manager.  If</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="comment"> *         rxapi is started through the command line or by CreateProcess(),</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="comment"> *         StartServiceCtrlDispatcher() will return</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment"> *         ERROR_FAILED_SERVICE_CONTROLLER_CONNECT and the service process will</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment"> *         not have run.</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00330"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a4a72894d1ae70e502c90e57b57b1d314">  330</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#a4a72894d1ae70e502c90e57b57b1d314">startTheService</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;{</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    SERVICE_TABLE_ENTRY st[] =</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    {</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;      {</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        (LPTSTR)<a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>,</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#a9d2fd619d19d31b6390ee3e6bbc1afcc">ServiceMain</a></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;      },</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;      {</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        NULL, NULL</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;      }</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    };</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160; </div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwServiceType = SERVICE_WIN32_OWN_PROCESS;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwCurrentState = SERVICE_STOPPED;</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwControlsAccepted = SERVICE_ACCEPT_STOP;</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwWin32ExitCode = 0;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwServiceSpecificExitCode = 0;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwCheckPoint = 0;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a>.dwWaitHint = 0;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160; </div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    <span class="keywordflow">return</span> StartServiceCtrlDispatcher(st) != 0;</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;}</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="comment"> * If rxapi is currently running as a Service process, then stop it.</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="comment"> * @param hService  Opened handle to the service.  The handle must have been</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="comment"> *                  opened with SERVICE_QUERY_STATUS and SERVICE_STOP access</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="comment"> *                  rights.</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment"> * @param timeOut   Time to wait, in miliseconds for a pending stop to clear.</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="comment"> * @return  True if the service is stopped, false if not sure that the service</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment"> *          is stopped.</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00366"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#ab1886bb8bc1d06dde55786719318c1f8">  366</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#ab1886bb8bc1d06dde55786719318c1f8">stopTheService</a>(SC_HANDLE hService, DWORD timeOut)</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;{</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    SERVICE_STATUS_PROCESS ssp;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    DWORD startTicks = GetTickCount();</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    DWORD waitTime = timeOut / 20;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    DWORD needed;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    <span class="keywordtype">bool</span> success = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160; </div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    <span class="comment">// See if the service is already stopped.</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <span class="keywordflow">if</span> ( ! QueryServiceStatusEx(hService, SC_STATUS_PROCESS_INFO, (LPBYTE)&amp;ssp, <span class="keyword">sizeof</span>(SERVICE_STATUS_PROCESS), &amp;needed) )</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    {</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        <span class="keywordflow">goto</span> finished;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    }</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160; </div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    <span class="keywordflow">if</span> ( ssp.dwCurrentState == SERVICE_STOPPED )</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    {</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        success = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        <span class="keywordflow">goto</span> finished;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    }</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160; </div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    <span class="comment">// When a service has a stop pending, we&#39;ll wait for it.</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keywordflow">while</span> ( ssp.dwCurrentState == SERVICE_STOP_PENDING )</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    {</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        Sleep(waitTime);</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        <span class="keywordflow">if</span> ( ! QueryServiceStatusEx(hService, SC_STATUS_PROCESS_INFO, (LPBYTE)&amp;ssp, <span class="keyword">sizeof</span>(SERVICE_STATUS_PROCESS), &amp;needed) )</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        {</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;            <span class="keywordflow">goto</span> finished;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        }</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160; </div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        <span class="keywordflow">if</span> ( ssp.dwCurrentState == SERVICE_STOPPED )</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;        {</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;            success = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;            <span class="keywordflow">goto</span> finished;</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        }</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160; </div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        <span class="keywordflow">if</span> ( GetTickCount() - startTicks &gt; timeOut )</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        {</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;            <span class="keywordflow">goto</span> finished;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;        }</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    }</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160; </div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <span class="comment">// Send a stop code through the Sevice Control Manager to the service</span></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    SERVICE_STATUS ss;</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <span class="keywordflow">if</span> ( ! ControlService(hService, SERVICE_CONTROL_STOP, &amp;ss) )</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    {</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        <span class="keywordflow">goto</span> finished;</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    }</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160; </div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    <span class="comment">// Wait for the service to stop</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="keywordflow">while</span> ( ssp.dwCurrentState != SERVICE_STOPPED )</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    {</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        Sleep(waitTime);</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="keywordflow">if</span> ( ! QueryServiceStatusEx(hService, SC_STATUS_PROCESS_INFO, (LPBYTE)&amp;ssp, <span class="keyword">sizeof</span>(SERVICE_STATUS_PROCESS), &amp;needed) )</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        {</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        }</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160; </div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        <span class="keywordflow">if</span> ( ss.dwCurrentState == SERVICE_STOPPED )</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        {</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;            success = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;        }</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160; </div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        <span class="keywordflow">if</span> ( GetTickCount() - startTicks &gt; timeOut )</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        {</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        }</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    }</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160; </div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;finished:</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    <span class="keywordflow">return</span> success;</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;}</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160; </div>
<div class="line"><a name="l00439"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a29ce16842044705a5b6a8ead236ebf4e">  439</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#a29ce16842044705a5b6a8ead236ebf4e">setServiceDACL</a>(SC_HANDLE hService)</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;{</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    EXPLICIT_ACCESS      ea;</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    SECURITY_DESCRIPTOR  sd;</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    PSECURITY_DESCRIPTOR psd            = NULL;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    PACL                 pacl           = NULL;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    PACL                 pNewAcl        = NULL;</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    BOOL                 bDaclPresent   = FALSE;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    BOOL                 bDaclDefaulted = FALSE;</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    DWORD                dwError        = 0;</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    DWORD                needed         = 0;</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160; </div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    <span class="comment">// Get the current security descriptor for the service.  First query with a</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    <span class="comment">// size of 0 to get the needed size.</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    <span class="keywordflow">if</span> ( ! QueryServiceObjectSecurity(hService, DACL_SECURITY_INFORMATION, &amp;psd, 0, &amp;needed) )</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    {</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;        <span class="keywordflow">if</span> ( GetLastError() == ERROR_INSUFFICIENT_BUFFER )</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;        {</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;            DWORD size = needed;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;            psd = (PSECURITY_DESCRIPTOR)LocalAlloc(LPTR, size);</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;            <span class="keywordflow">if</span> (psd == NULL)</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;            {</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                <span class="keywordflow">goto</span> <a class="code" href="rxsock_8h.html#ab7778d715a528c193b316a8519d62bda">cleanup</a>;</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;            }</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160; </div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;            <span class="keywordflow">if</span> ( ! QueryServiceObjectSecurity( hService, DACL_SECURITY_INFORMATION, psd, size, &amp;needed) )</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;            {</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                <span class="keywordflow">goto</span> <a class="code" href="rxsock_8h.html#ab7778d715a528c193b316a8519d62bda">cleanup</a>;</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;            }</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        }</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;        {</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;            <span class="keywordflow">goto</span> <a class="code" href="rxsock_8h.html#ab7778d715a528c193b316a8519d62bda">cleanup</a>;</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        }</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    }</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160; </div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <span class="comment">// Get the current DACL from the security descriptor.</span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="keywordflow">if</span> ( ! GetSecurityDescriptorDacl(psd, &amp;bDaclPresent, &amp;pacl, &amp;bDaclDefaulted) )</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    {</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        <span class="keywordflow">goto</span> <a class="code" href="rxsock_8h.html#ab7778d715a528c193b316a8519d62bda">cleanup</a>;</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    }</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160; </div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="comment">// Build the ACE.</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    BuildExplicitAccessWithName(&amp;ea, TEXT(<span class="stringliteral">&quot;Users&quot;</span>), SERVICE_START | SERVICE_STOP | GENERIC_READ, SET_ACCESS, NO_INHERITANCE);</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160; </div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    dwError = SetEntriesInAcl(1, (PEXPLICIT_ACCESS)&amp;ea, pacl, &amp;pNewAcl);</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    <span class="keywordflow">if</span> ( dwError != ERROR_SUCCESS )</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    {</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        <span class="keywordflow">goto</span> <a class="code" href="rxsock_8h.html#ab7778d715a528c193b316a8519d62bda">cleanup</a>;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    }</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160; </div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="comment">// Initialize a new security descriptor.</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="keywordflow">if</span> ( ! InitializeSecurityDescriptor(&amp;sd, SECURITY_DESCRIPTOR_REVISION) )</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    {</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        <span class="keywordflow">goto</span> <a class="code" href="rxsock_8h.html#ab7778d715a528c193b316a8519d62bda">cleanup</a>;</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    }</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160; </div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    <span class="comment">// Set the new DACL in the security descriptor.</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="keywordflow">if</span> ( ! SetSecurityDescriptorDacl(&amp;sd, TRUE, pNewAcl, FALSE) )</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    {</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;        <span class="keywordflow">goto</span> <a class="code" href="rxsock_8h.html#ab7778d715a528c193b316a8519d62bda">cleanup</a>;</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    }</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160; </div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="comment">// Set the new security descriptor for the service object.</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    SetServiceObjectSecurity(hService, DACL_SECURITY_INFORMATION, &amp;sd);</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160; </div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<a class="code" href="rxsock_8h.html#ab7778d715a528c193b316a8519d62bda">cleanup</a>:</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    <span class="keywordflow">if</span>( pNewAcl != NULL )</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    {</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        LocalFree((HLOCAL)pNewAcl);</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    }</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    <span class="keywordflow">if</span>( psd != NULL )</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    {</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;        LocalFree((LPVOID)psd);</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    }</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;}</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;<span class="comment"> * Install rxapi as a Windows service and add the registry entries to allow</span></div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="comment"> * logging through the Event Log service.</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="comment"> * @return True if the service was installed, otherwise false.</span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00522"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#add3df505ce5aac8c66a06f0e74c36bec">  522</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#add3df505ce5aac8c66a06f0e74c36bec">Install</a>()</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;{</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <span class="keywordtype">char</span> szFilePath[_MAX_PATH];</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    SC_HANDLE hService = NULL;</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    <span class="keywordtype">char</span> szKey[_MAX_PATH];</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    HKEY hKey = NULL;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    DWORD dwData;</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    <span class="keywordtype">bool</span> success = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160; </div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;    <span class="comment">// Open the Service Control Manager</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;    SC_HANDLE hSCM = OpenSCManager(NULL, NULL, SC_MANAGER_CREATE_SERVICE | SC_MANAGER_CONNECT);</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="keywordflow">if</span> ( hSCM == NULL )</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    {</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="rxsock_8h.html#ab7778d715a528c193b316a8519d62bda">cleanup</a>;</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    }</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160; </div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    <span class="comment">// Get the executable file path.  The docs for Services say that if the path</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="comment">// contains spaces it must be quoted.</span></div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160; </div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    <span class="comment">// Use szKey as a temp buffer.</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    GetModuleFileName(NULL, szKey, <span class="keyword">sizeof</span>(szKey));</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="keywordflow">if</span> ( strstr(szKey, <span class="stringliteral">&quot; &quot;</span>) == 0 )</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    {</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;        strcpy(szFilePath, szKey);</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    }</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    {</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        _snprintf(szFilePath, <span class="keyword">sizeof</span>(szFilePath), <span class="stringliteral">&quot;\&quot;%s\&quot;&quot;</span>, szKey);</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    }</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160; </div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    <span class="comment">// Create the service</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    hService = CreateService(hSCM, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>, SERVICE_ALL_ACCESS, SERVICE_WIN32_OWN_PROCESS,</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                             SERVICE_AUTO_START, SERVICE_ERROR_NORMAL, szFilePath, NULL, NULL, NULL, NULL,</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                             NULL);</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160; </div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    <span class="keywordflow">if</span> ( hService == NULL )</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    {</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;        <span class="keywordflow">goto</span> <a class="code" href="rxsock_8h.html#ab7778d715a528c193b316a8519d62bda">cleanup</a>;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    }</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160; </div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;    <span class="comment">// At this point, the service is installed, so success is set to true.  The</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    <span class="comment">// rest of the stuff is icing on the cake so to speak.  If something fails,</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    <span class="comment">// it might be nice to notify someone, but we shouldn&#39;t say the service</span></div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    <span class="comment">// install failed, because it hasn&#39;t.</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    success = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160; </div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    <span class="comment">// ChangeServiceConfig2() needs W2K or later.</span></div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="windows_2_a_p_i_service_8cpp.html#aee50b830b6eba5b46093d05381d9e898">isAtLeastVersion</a>(<a class="code" href="windows_2_a_p_i_service_8cpp.html#ac7c596526f9e0fd9e9adbf618e2bf815a71176e3a910ac13880a59b1628147ff6">Windows_2K</a>) )</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    {</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        <span class="comment">// Use szKey as a temporary buffer</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        sprintf(szKey, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a28991060ad7eef75ae01f4c3b23c1da6">SERVICEDESCRIPTION</a>, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>, ORX_VER, ORX_REL, ORX_MOD);</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#abae38490a0892e0d880cf72efb4e0378">Info</a>.lpDescription = szKey;</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160; </div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        ChangeServiceConfig2(hService, SERVICE_CONFIG_DESCRIPTION, &amp;<a class="code" href="windows_2_a_p_i_service_8cpp.html#abae38490a0892e0d880cf72efb4e0378">Info</a>);</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    }</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160; </div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    <span class="comment">// Set the discretionary ACL for the service.</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a29ce16842044705a5b6a8ead236ebf4e">setServiceDACL</a>(hService);</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160; </div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    <span class="comment">// Add the registry entries to support logging messages.  The source name is</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    <span class="comment">// added as a subkey under the Application key in the EventLog service</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    <span class="comment">// portion of the registry.</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    strcpy(szKey, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a760469f363ac78dbda04c9da73fe3224">APP_LOG_KEYNAME</a>);</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;    strcat(szKey, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>);</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160; </div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    <span class="keywordflow">if</span> ( RegCreateKey(HKEY_LOCAL_MACHINE, szKey, &amp;hKey) == ERROR_SUCCESS )</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    {</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;        <span class="comment">// Set the value of &#39;EventMessageFile&#39; to the Event ID message-file name.</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;        RegSetValueEx(hKey, <span class="stringliteral">&quot;EventMessageFile&quot;</span>, 0, REG_EXPAND_SZ, (CONST BYTE*)szFilePath,</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;                      (DWORD)strlen(szFilePath) + 1);</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160; </div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        <span class="comment">// Set the value of &#39;TypesSupported&#39; to the supported types.</span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        dwData = EVENTLOG_ERROR_TYPE | EVENTLOG_WARNING_TYPE | EVENTLOG_INFORMATION_TYPE;</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        RegSetValueEx(hKey, <span class="stringliteral">&quot;TypesSupported&quot;</span>, 0, REG_DWORD, (CONST BYTE*)&amp;dwData, <span class="keyword">sizeof</span>(DWORD));</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160; </div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        RegCloseKey(hKey);</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    }</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160; </div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<a class="code" href="rxsock_8h.html#ab7778d715a528c193b316a8519d62bda">cleanup</a>:</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    <span class="keywordflow">if</span> ( hService != NULL )</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    {</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        CloseServiceHandle(hService);</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    }</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    <span class="keywordflow">if</span> ( hSCM != NULL )</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    {</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        CloseServiceHandle(hSCM);</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    }</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    <span class="keywordflow">return</span> success;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;}</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;<span class="comment"> * Deletes rxapi as a service and cleans up the registry entries that were made</span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="comment"> * when rxapi was installed as a service.</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;<span class="comment"> * @return true on success, othewise false.</span></div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00618"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a7f7a03f7a4079cb2ac53eb684da29533">  618</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#a7f7a03f7a4079cb2ac53eb684da29533">Uninstall</a>()</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;{</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    <span class="keywordtype">bool</span> success = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160; </div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    <span class="comment">// Open the Service Control Manager</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    SC_HANDLE hSCM = OpenSCManager(NULL, NULL, SC_MANAGER_CONNECT);</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    <span class="keywordflow">if</span> ( hSCM != NULL )</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    {</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;        SC_HANDLE hService = OpenService(hSCM, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>, DELETE | SERVICE_QUERY_STATUS | SERVICE_STOP);</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        <span class="keywordflow">if</span> ( hService != NULL )</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        {</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;            <span class="comment">// First stop the service if it is running, which allows the Service</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;            <span class="comment">// Control Manger to clean up the database immediately.  If we fail</span></div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;            <span class="comment">// to stop the service we just ignore it.  The database will be</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;            <span class="comment">// cleaned up at the next reboot. (Or sooner if the rxapi process is</span></div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;            <span class="comment">// killed.)</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;            <a class="code" href="windows_2_a_p_i_service_8cpp.html#ab1886bb8bc1d06dde55786719318c1f8">stopTheService</a>(hService, 1000);</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160; </div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;            <span class="keywordflow">if</span> ( DeleteService(hService) )</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;            {</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                success = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;            }</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;            CloseServiceHandle(hService);</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;        }</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;        CloseServiceHandle(hSCM);</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    }</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160; </div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    <span class="comment">// Remove the Event Log service entries in the registry for rxapi.  These</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    <span class="comment">// entries are added during the Service installation function.  Any errors</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    <span class="comment">// are just ignored.</span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;    <span class="keywordflow">if</span> ( success )</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;    {</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;        HKEY hKey = NULL;</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        <span class="keywordflow">if</span> ( RegOpenKeyEx(HKEY_LOCAL_MACHINE, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a760469f363ac78dbda04c9da73fe3224">APP_LOG_KEYNAME</a>, 0, DELETE, &amp;hKey) == ERROR_SUCCESS )</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        {</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;            <span class="keywordflow">if</span> ( RegDeleteKey(hKey, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>) == ERROR_SUCCESS )</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;            {</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                RegCloseKey(hKey);</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            }</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;        }</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    }</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    <span class="keywordflow">return</span> success;</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;}</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;<span class="comment"> * Determines if the service is currently running.</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="comment"> * If the current state is START PENDING will wait until the service is running</span></div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;<span class="comment"> * or times out.</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="comment"> * @param hService  Handle to the opened service.  Note that the handle has to</span></div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;<span class="comment"> *                  have been opened with SERVICE_QUERY_STATUS so that we can</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="comment"> *                  use QueryServiceStatusEx().</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="comment"> * @return True if the service is running, false otherwise.</span></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00674"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a841b09ebff913cd97433d7d0a34ab478">  674</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#a841b09ebff913cd97433d7d0a34ab478">serviceIsRunning</a>(SC_HANDLE hService)</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;{</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    SERVICE_STATUS_PROCESS ssp;</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    DWORD                 needed;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160; </div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    BOOL success = QueryServiceStatusEx(hService, SC_STATUS_PROCESS_INFO, (LPBYTE)&amp;ssp,</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;                                        <span class="keyword">sizeof</span>(SERVICE_STATUS_PROCESS), &amp;needed);</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160; </div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    <span class="keywordflow">if</span> ( success )</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    {</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        <span class="keywordflow">if</span> ( ssp.dwCurrentState == SERVICE_RUNNING || ssp.dwCurrentState == SERVICE_STOPPED ||</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;             ssp.dwCurrentState == SERVICE_STOP_PENDING )</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;        {</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            <span class="keywordflow">return</span> ssp.dwCurrentState == SERVICE_RUNNING;</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;        }</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160; </div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;        <span class="keywordflow">if</span> ( ssp.dwCurrentState == SERVICE_START_PENDING )</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;        {</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;            <span class="comment">// Save the tick count and initial checkpoint.</span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;            <a class="code" href="windows_2rexxapitypes_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> startTicks = GetTickCount();</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;            <a class="code" href="windows_2rexxapitypes_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> oldCheck = ssp.dwCheckPoint;</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;            <a class="code" href="windows_2rexxapitypes_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> waitTime;</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160; </div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;            <span class="comment">// Check the status until the service is no longer start pending.</span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;            <span class="comment">// rxapi is not pausable, so PAUSED or PAUSED_PENDING should not be</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;            <span class="comment">// possible.</span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;            <span class="keywordflow">while</span> ( ssp.dwCurrentState == SERVICE_START_PENDING )</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;            {</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;                <span class="comment">// Do not wait longer than the wait hint, which for rxapi will</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;                <span class="comment">// be 2000 milliseconds.</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;                <span class="comment">// Microsoft suggests that a good interval is one tenth the wait</span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;                <span class="comment">// hint, but not less than 1 second and no more than 10 seconds.</span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;                <span class="comment">// rxapi usually starts in less than 200 milliseconds.</span></div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;                waitTime = ssp.dwWaitHint / 10;</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160; </div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;                <span class="keywordflow">if</span>( waitTime &lt; 200 )</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;                {</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;                    waitTime = 200;</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;                }</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( waitTime &gt; 10000 )</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;                {</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;                    waitTime = 10000;</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;                }</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160; </div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;                Sleep(waitTime);</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160; </div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;                BOOL success = QueryServiceStatusEx(hService, SC_STATUS_PROCESS_INFO, (LPBYTE)&amp;ssp,</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;                                                    <span class="keyword">sizeof</span>(SERVICE_STATUS_PROCESS), &amp;needed);</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;                <span class="keywordflow">if</span> ( ! success || ssp.dwCurrentState == SERVICE_RUNNING )</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;                {</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;                }</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160; </div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;                <span class="keywordflow">if</span> ( ssp.dwCheckPoint &gt; oldCheck )</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;                {</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;                    <span class="comment">// The service is making progress, so continue.</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;                    startTicks = GetTickCount();</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;                    oldCheck = ssp.dwCheckPoint;</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;                }</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;                {</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;                    <span class="keywordflow">if</span>( (GetTickCount() - startTicks) &gt; ssp.dwWaitHint )</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;                    {</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;                        <span class="comment">// The wait hint interval has expired and we are still</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;                        <span class="comment">// not started, so quit.</span></div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;                    }</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;                }</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;            }</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160; </div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;            <span class="keywordflow">return</span> ssp.dwCurrentState == SERVICE_RUNNING;</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;        }</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    }</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;}</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;<span class="comment"> * Determines if: rxapi is installed as a service and is already running, is</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="comment"> * installed as a service but not running, installed but the service is</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="comment"> * currently disabled, or not installed as a service.</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;<span class="comment"> * @return  One of the 4 service state enums.</span></div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00758"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a51d8b7aae2c9affa9d498b0bd687be22">  758</a></span>&#160;<a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4c">ServiceStateType</a> <a class="code" href="windows_2_a_p_i_service_8cpp.html#a51d8b7aae2c9affa9d498b0bd687be22">getServiceState</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;{</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4c">ServiceStateType</a> state = <a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4ca39c75059f37cc59c3a334424b03e3255">uninstalled_state</a>;</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160; </div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    <span class="comment">// Open the Service Control Manager</span></div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    SC_HANDLE hSCM = OpenSCManager(NULL, SERVICES_ACTIVE_DATABASE, SC_MANAGER_CONNECT);</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <span class="keywordflow">if</span> ( hSCM )</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    {</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;        <span class="comment">// Try to open the service, if this fails, rxapi is not installed as a</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        <span class="comment">// service.</span></div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;        SC_HANDLE hService = OpenService(hSCM, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>, SERVICE_QUERY_CONFIG | SERVICE_QUERY_STATUS);</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;        <span class="keywordflow">if</span> ( hService )</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;        {</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;            <span class="comment">// The service is definitely installed, we&#39;ll mark it as disabled</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;            <span class="comment">// until we know for sure it is not disabled.</span></div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;            state = <a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4cac5eb4b9150dfb16b4c3d23108a896f5e">disabled_state</a>;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160; </div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;            LPQUERY_SERVICE_CONFIG pqsc = (LPQUERY_SERVICE_CONFIG)LocalAlloc(LPTR, 4096);</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;            <span class="keywordflow">if</span> ( pqsc )</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;            {</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;                DWORD needed;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;                <span class="keywordflow">if</span> ( QueryServiceConfig(hService, pqsc, 4096, &amp;needed) )</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;                {</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;                    <span class="keywordflow">if</span> ( pqsc-&gt;dwStartType != SERVICE_DISABLED )</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;                    {</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;                        state = <a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4ca6c794638ad6911b18c88b63c66644ccb">installed_state</a>;</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;                    }</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;                }</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;                LocalFree(pqsc);</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;            }</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160; </div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;            <span class="keywordflow">if</span> ( state == <a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4ca6c794638ad6911b18c88b63c66644ccb">installed_state</a> )</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;            {</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;                <span class="comment">// See if rxapi is already running as a service.</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;                <span class="keywordflow">if</span> ( <a class="code" href="windows_2_a_p_i_service_8cpp.html#a841b09ebff913cd97433d7d0a34ab478">serviceIsRunning</a>(hService) )</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;                {</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                    state = <a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4ca3c06b409a56950df36953bbafccae019">running_state</a>;</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;                }</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;            }</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;            CloseServiceHandle(hService);</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;        }</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        CloseServiceHandle(hSCM);</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    }</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    <span class="keywordflow">return</span> state;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;}</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;<span class="comment"> * Start rxapi as a Windows Service, if possible.  This function determines if</span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="comment"> * rxapi is installed as a Service and if it is already running as a service.</span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;<span class="comment"> * If it is installled as a service, but not running, an attempt is made to</span></div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="comment"> * start it as a Service.</span></div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;<span class="comment"> * @return True if now running as a Windows Service, otherwis false.</span></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00813"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a1aad658895859bc0e7c1f6abae799b19">  813</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#a1aad658895859bc0e7c1f6abae799b19">startAsWindowsService</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;{</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    <span class="keywordtype">bool</span> started;</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    DWORD errRC;</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    <span class="keywordtype">int</span> iRet;</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160; </div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4c">ServiceStateType</a> state = <a class="code" href="windows_2_a_p_i_service_8cpp.html#a51d8b7aae2c9affa9d498b0bd687be22">getServiceState</a>();</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    <span class="keywordflow">if</span> ( state == <a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4ca3c06b409a56950df36953bbafccae019">running_state</a> )</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    {</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    }</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160; </div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    <span class="keywordflow">if</span> ( state == <a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4ca6c794638ad6911b18c88b63c66644ccb">installed_state</a> )</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    {</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;        <span class="comment">// When the service is started successfully here, we do not return until</span></div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;        <span class="comment">// the service has been stopped.</span></div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;        started = <a class="code" href="windows_2_a_p_i_service_8cpp.html#a4a72894d1ae70e502c90e57b57b1d314">startTheService</a>();</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160; </div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;        <span class="keywordflow">if</span> ( ! started )</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;        {</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;            <span class="comment">// The service did not start, get the error code.</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;            errRC = GetLastError();</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;            <span class="keywordflow">if</span> ( errRC == ERROR_FAILED_SERVICE_CONTROLLER_CONNECT )</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;            {</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;                <span class="comment">// This specific error happens when rxapi is not running and is</span></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;                <span class="comment">// started from the command line or by CreateProcess().  Service</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;                <span class="comment">// processes can not run when started as console programs.</span></div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;                <span class="comment">// (Really we should educate the user not to do this.)  We use</span></div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;                <span class="comment">// NET START RXAPI, which will invoke the service controller to</span></div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;                <span class="comment">// start rxapi correctly. When we return from system(), rxapi</span></div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;                <span class="comment">// will be running as a service in another process, so it is</span></div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;                <span class="comment">// important to exit this process.</span></div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160; </div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;                iRet = system(<span class="stringliteral">&quot;NET start rxapi&quot;</span>);</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160; </div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;                <span class="comment">// If the return is not 0, rxapi was not started as a service.</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;                <span class="keywordflow">return</span> iRet == 0;</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;            }</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;            {</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;                <span class="comment">// The service could not be started for some un-anticipated</span></div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;                <span class="comment">// reason.  Return false so that rxapi will continue by running</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;                <span class="comment">// as a standard process.</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;            }</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;        }</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160; </div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;        <span class="comment">// Do not continue by running rxapi as a standard process.</span></div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    }</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160; </div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    <span class="comment">// Either rxapi is not installed as a Service, or the Service has been set</span></div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    <span class="comment">// to disabled. Continue by running rxapi as a standard process.</span></div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;}</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;<span class="comment"> * We have command line args, process them.  Most likely the args are to install</span></div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;<span class="comment"> * or uninstall rxapi as a service.</span></div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;<span class="comment"> * @param cmdLine The command line, must not be null.</span></div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00875"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#ac996592006c7fb836030f7bf754ff0b4">  875</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="windows_2_a_p_i_service_8cpp.html#ac996592006c7fb836030f7bf754ff0b4">processCmdLine</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *cmdLine)</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;{</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    <span class="keywordtype">char</span> msg[256];</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    <span class="keywordtype">bool</span> verbose = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160; </div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    <span class="keywordtype">size_t</span> len = strlen(cmdLine);</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160; </div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    <span class="keywordflow">if</span> ( cmdLine[0] != <span class="charliteral">&#39;/&#39;</span> || len &lt; 2 )</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    {</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;        <a class="code" href="windows_2_a_p_i_service_8cpp.html#aebee0c998e0babaa2e0ae259b22a9f0f">showMessage</a>(<a class="code" href="windows_2_a_p_i_service_8cpp.html#ad281533a525c10171eb5c0151f5b07b8">SYNTAX_HELP</a>, MB_ICONERROR);</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    }</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160; </div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    <span class="keywordflow">if</span> ( len &gt;= 5 )</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    {</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;        <span class="keywordtype">char</span> opt = cmdLine[4];</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;        <span class="keywordflow">if</span> ( opt == <span class="charliteral">&#39;s&#39;</span> || opt == <span class="charliteral">&#39;S&#39;</span> || opt == <span class="charliteral">&#39;q&#39;</span> || opt == <span class="charliteral">&#39;Q&#39;</span> )</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;        {</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;            verbose = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;        }</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    }</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160; </div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    <span class="keywordtype">bool</span> isInstalled = (<a class="code" href="windows_2_a_p_i_service_8cpp.html#a51d8b7aae2c9affa9d498b0bd687be22">getServiceState</a>() != <a class="code" href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4ca39c75059f37cc59c3a334424b03e3255">uninstalled_state</a>);</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160; </div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;    <span class="keywordflow">switch</span> ( cmdLine[1] )</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    {</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;        <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span> :</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;        <span class="keywordflow">case</span> <span class="charliteral">&#39;V&#39;</span> :</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;            sprintf(msg ,<span class="stringliteral">&quot;%s Version %d.%d.%d\n\nThe service is %s installed&quot;</span>, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>,</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;                    ORX_VER, ORX_REL, ORX_MOD, isInstalled ? <span class="stringliteral">&quot;currently&quot;</span> : <span class="stringliteral">&quot;not&quot;</span>);</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;            <a class="code" href="windows_2_a_p_i_service_8cpp.html#aebee0c998e0babaa2e0ae259b22a9f0f">showMessage</a>(msg, MB_ICONINFORMATION);</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160; </div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;        <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span> :</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        <span class="keywordflow">case</span> <span class="charliteral">&#39;I&#39;</span> :</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;            <span class="keywordflow">if</span> ( isInstalled )</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;            {</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;                <span class="keywordflow">if</span> ( verbose )</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;                {</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                    sprintf(msg, <span class="stringliteral">&quot;%s is already installed as a service.&quot;</span>, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>);</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;                    <a class="code" href="windows_2_a_p_i_service_8cpp.html#aebee0c998e0babaa2e0ae259b22a9f0f">showMessage</a>(msg, MB_ICONWARNING);</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                }</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;            }</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;            {</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;                <span class="keywordflow">if</span> ( <a class="code" href="windows_2_a_p_i_service_8cpp.html#add3df505ce5aac8c66a06f0e74c36bec">Install</a>() )</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                {</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;                    <span class="keywordflow">if</span> ( verbose )</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;                    {</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;                        sprintf(msg, <span class="stringliteral">&quot;The %s service was installed\n&quot;</span>, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>);</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;                        <a class="code" href="windows_2_a_p_i_service_8cpp.html#aebee0c998e0babaa2e0ae259b22a9f0f">showMessage</a>(msg, MB_ICONINFORMATION);</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;                    }</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;                }</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;                {</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;                    <span class="keywordflow">if</span> ( verbose )</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;                    {</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;                        sprintf(msg, <span class="stringliteral">&quot;The %s service failed to install.\n&quot;</span></div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;                                     <span class="stringliteral">&quot;Error %d\n&quot;</span>, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>, GetLastError());</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;                        <a class="code" href="windows_2_a_p_i_service_8cpp.html#aebee0c998e0babaa2e0ae259b22a9f0f">showMessage</a>(msg, MB_ICONERROR);</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;                    }</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;                }</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;            }</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160; </div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;        <span class="keywordflow">case</span> <span class="charliteral">&#39;u&#39;</span> :</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;        <span class="keywordflow">case</span> <span class="charliteral">&#39;U&#39;</span> :</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;            <span class="keywordflow">if</span> ( ! isInstalled )</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;            {</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;                <span class="keywordflow">if</span> ( verbose )</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;                {</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;                    sprintf(msg, <span class="stringliteral">&quot;%s is not installed as a service\n&quot;</span>, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>);</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;                    <a class="code" href="windows_2_a_p_i_service_8cpp.html#aebee0c998e0babaa2e0ae259b22a9f0f">showMessage</a>(msg, MB_ICONWARNING);</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;                }</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;            }</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;            {</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;                <span class="keywordflow">if</span> ( <a class="code" href="windows_2_a_p_i_service_8cpp.html#a7f7a03f7a4079cb2ac53eb684da29533">Uninstall</a>() )</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;                {</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;                    <span class="keywordflow">if</span> ( verbose )</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;                    {</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;                        sprintf(msg, <span class="stringliteral">&quot;%s was uninstalled as a service.\n\n&quot;</span></div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;                                     <span class="stringliteral">&quot;(Open Object REXX is not uninstalled.)&quot;</span>, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>);</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;                        <a class="code" href="windows_2_a_p_i_service_8cpp.html#aebee0c998e0babaa2e0ae259b22a9f0f">showMessage</a>(msg, MB_ICONINFORMATION);</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;                    }</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;                }</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;                {</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;                    <span class="keywordflow">if</span> ( verbose )</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;                    {</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;                        sprintf(msg, <span class="stringliteral">&quot;The %s service could not be uninstalled.\n&quot;</span></div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;                                     <span class="stringliteral">&quot;Error %d\n&quot;</span>, <a class="code" href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a>, GetLastError());</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;                        <a class="code" href="windows_2_a_p_i_service_8cpp.html#aebee0c998e0babaa2e0ae259b22a9f0f">showMessage</a>(msg, MB_ICONERROR);</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;                    }</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;                }</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;            }</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160; </div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;        default :</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;            <a class="code" href="windows_2_a_p_i_service_8cpp.html#aebee0c998e0babaa2e0ae259b22a9f0f">showMessage</a>(<a class="code" href="windows_2_a_p_i_service_8cpp.html#ad281533a525c10171eb5c0151f5b07b8">SYNTAX_HELP</a>, MB_ICONERROR);</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;    }</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;}</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;<span class="comment">/**</span></div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;<span class="comment"> * The main entry point for rxapi.exe.</span></div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;<span class="comment"> * When rxapi is installed as a service, the invoker might be the service</span></div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;<span class="comment"> * control manager, or the interpreter could be starting rxapi as a service</span></div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;<span class="comment"> * because rxapi was not running.</span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;<span class="comment"> * When rxapi is not installed as a service, then the invoker is most likely the</span></div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;<span class="comment"> * interpreter starting up rxapi.  Although, the user could also be invoking</span></div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="comment"> * rxapi from the command line.</span></div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;<span class="comment"> * The third possibility is that rxapi is being invoked from the command line</span></div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;<span class="comment"> * with arguments to either install, uninstall, or query rxapi as a service.</span></div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;<span class="comment"> * @param hInstance</span></div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;<span class="comment"> * @param hPrevInstance</span></div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;<span class="comment"> * @param lpCmdLine       The only arg we are interested in, the command line</span></div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;<span class="comment"> *                        arguments.</span></div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;<span class="comment"> * @param nCmdShow</span></div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;<span class="comment"> * @return 0</span></div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l01003"></a><span class="lineno"><a class="line" href="windows_2_a_p_i_service_8cpp.html#a1122673f59be78a3997ec7dd1c4688f9"> 1003</a></span>&#160;<span class="keywordtype">int</span> APIENTRY <a class="code" href="windows_2_a_p_i_service_8cpp.html#a1122673f59be78a3997ec7dd1c4688f9">WinMain</a>(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="keywordtype">int</span> nCmdShow)</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;{</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    <span class="keywordflow">if</span> ( <a class="code" href="windows_2_a_p_i_service_8cpp.html#aee50b830b6eba5b46093d05381d9e898">isAtLeastVersion</a>(<a class="code" href="windows_2_a_p_i_service_8cpp.html#ac7c596526f9e0fd9e9adbf618e2bf815acb9da7f09e73b1a6eed5000606d2c5bd">Windows_NT</a>) )</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    {</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;        <span class="comment">// If there are args, we always process them and exit.</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;        <span class="keywordflow">if</span> ( strlen(lpCmdLine) != 0 )</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;        {</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;            <a class="code" href="windows_2_a_p_i_service_8cpp.html#ac996592006c7fb836030f7bf754ff0b4">processCmdLine</a>(lpCmdLine);</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;            exit(0);</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;        }</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160; </div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;        <span class="comment">// If rxapi is already running as a service then startAsWindowsService()</span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;        <span class="comment">// will return immediately and we will exit.  Otherwise, the function</span></div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;        <span class="comment">// will attempt to strart rxapi as a service. If successful, we do not</span></div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;        <span class="comment">// return from startAsWindowService() until the service is stopped.</span></div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        <span class="keywordflow">if</span> ( <a class="code" href="windows_2_a_p_i_service_8cpp.html#a1aad658895859bc0e7c1f6abae799b19">startAsWindowsService</a>() )</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;        {</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;            <span class="comment">// rxapi was already running as a service, or rxapi was started and</span></div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;            <span class="comment">// ran as a service, and is now ended / stopped.</span></div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;            exit(0);</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;        }</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;    }</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160; </div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;    <span class="comment">// For some reason we are not running as an installed service, (either not</span></div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;    <span class="comment">// installed as service, the user does not have the authority to start a</span></div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;    <span class="comment">// stopped service, or some other reason.) In this case, run rxapi as a</span></div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    <span class="comment">// normal process.</span></div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    <a class="code" href="windows_2_a_p_i_service_8cpp.html#a7a0190d9005c22d5b7e4677bf336669e">Run</a>(<span class="keyword">false</span>);</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160; </div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;}</div>
<div class="ttc" id="a_a_p_i_server_8hpp_html"><div class="ttname"><a href="_a_p_i_server_8hpp.html">APIServer.hpp</a></div></div>
<div class="ttc" id="aclass_a_p_i_server_html"><div class="ttname"><a href="class_a_p_i_server.html">APIServer</a></div><div class="ttdef"><b>Definition:</b> <a href="_a_p_i_server_8hpp_source.html#l00052">APIServer.hpp:53</a></div></div>
<div class="ttc" id="aclass_a_p_i_server_html_a4881b9353d97feb93dbd9b08b6153438"><div class="ttname"><a href="class_a_p_i_server.html#a4881b9353d97feb93dbd9b08b6153438">APIServer::initServer</a></div><div class="ttdeci">void initServer()</div><div class="ttdef"><b>Definition:</b> <a href="_a_p_i_server_8cpp_source.html#l00053">APIServer.cpp:53</a></div></div>
<div class="ttc" id="aclass_a_p_i_server_html_a5323f78df981e82f09e8428fb300132a"><div class="ttname"><a href="class_a_p_i_server.html#a5323f78df981e82f09e8428fb300132a">APIServer::terminateServer</a></div><div class="ttdeci">void terminateServer()</div><div class="ttdef"><b>Definition:</b> <a href="_a_p_i_server_8cpp_source.html#l00069">APIServer.cpp:69</a></div></div>
<div class="ttc" id="aclass_a_p_i_server_html_a91fbbfde0e42d5d498d03a6911a20d72"><div class="ttname"><a href="class_a_p_i_server.html#a91fbbfde0e42d5d498d03a6911a20d72">APIServer::listenForConnections</a></div><div class="ttdeci">void listenForConnections()</div><div class="ttdef"><b>Definition:</b> <a href="_a_p_i_server_8cpp_source.html#l00082">APIServer.cpp:82</a></div></div>
<div class="ttc" id="aclass_service_exception_html"><div class="ttname"><a href="class_service_exception.html">ServiceException</a></div><div class="ttdef"><b>Definition:</b> <a href="_service_exception_8hpp_source.html#l00067">ServiceException.hpp:68</a></div></div>
<div class="ttc" id="acmdparse_8cpp_html_ac765329451135abec74c45e1897abf26"><div class="ttname"><a href="cmdparse_8cpp.html#ac765329451135abec74c45e1897abf26">type</a></div><div class="ttdeci">int type</div><div class="ttdef"><b>Definition:</b> <a href="cmdparse_8cpp_source.html#l00383">cmdparse.cpp:383</a></div></div>
<div class="ttc" id="arxsock_8h_html_ab7778d715a528c193b316a8519d62bda"><div class="ttname"><a href="rxsock_8h.html#ab7778d715a528c193b316a8519d62bda">cleanup</a></div><div class="ttdeci">void cleanup(RexxCallContext *context)</div><div class="ttdef"><b>Definition:</b> <a href="rxsock_8cpp_source.html#l00584">rxsock.cpp:584</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a1122673f59be78a3997ec7dd1c4688f9"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a1122673f59be78a3997ec7dd1c4688f9">WinMain</a></div><div class="ttdeci">int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow)</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l01003">windows/APIService.cpp:1003</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a196495707f4f3c6541853e97825a2bf6"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a196495707f4f3c6541853e97825a2bf6">m_Status</a></div><div class="ttdeci">static SERVICE_STATUS m_Status</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00063">windows/APIService.cpp:63</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a1aad658895859bc0e7c1f6abae799b19"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a1aad658895859bc0e7c1f6abae799b19">startAsWindowsService</a></div><div class="ttdeci">bool startAsWindowsService(void)</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00813">windows/APIService.cpp:813</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a1f7a270efc8c68a09857e333c6d0fb07"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a1f7a270efc8c68a09857e333c6d0fb07">OnUserControl</a></div><div class="ttdeci">BOOL OnUserControl(DWORD dwOpcode)</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00200">windows/APIService.cpp:200</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a23b0fbb531c015934ac8c77e7e248017"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a23b0fbb531c015934ac8c77e7e248017">OnShutdown</a></div><div class="ttdeci">void OnShutdown()</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00195">windows/APIService.cpp:195</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a248c764067ee60c03ee370784c49f353"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a248c764067ee60c03ee370784c49f353">Initialize</a></div><div class="ttdeci">bool Initialize()</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00255">windows/APIService.cpp:255</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a28991060ad7eef75ae01f4c3b23c1da6"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a28991060ad7eef75ae01f4c3b23c1da6">SERVICEDESCRIPTION</a></div><div class="ttdeci">#define SERVICEDESCRIPTION</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00044">windows/APIService.cpp:44</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a29ce16842044705a5b6a8ead236ebf4e"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a29ce16842044705a5b6a8ead236ebf4e">setServiceDACL</a></div><div class="ttdeci">void setServiceDACL(SC_HANDLE hService)</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00439">windows/APIService.cpp:439</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a32e64ee1e25eb248e6c4f0bfba0a3d77"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a32e64ee1e25eb248e6c4f0bfba0a3d77">m_hServiceStatus</a></div><div class="ttdeci">static SERVICE_STATUS_HANDLE m_hServiceStatus</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00062">windows/APIService.cpp:62</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a4a72894d1ae70e502c90e57b57b1d314"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a4a72894d1ae70e502c90e57b57b1d314">startTheService</a></div><div class="ttdeci">bool startTheService(void)</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00330">windows/APIService.cpp:330</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a51d8b7aae2c9affa9d498b0bd687be22"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a51d8b7aae2c9affa9d498b0bd687be22">getServiceState</a></div><div class="ttdeci">ServiceStateType getServiceState(void)</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00758">windows/APIService.cpp:758</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a62266bf9e4b6b83d58e570ce14a1a63e"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a62266bf9e4b6b83d58e570ce14a1a63e">OnContinue</a></div><div class="ttdeci">void OnContinue()</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00190">windows/APIService.cpp:190</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a6f12d541be60d3ff420ee381789de5c6"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a6f12d541be60d3ff420ee381789de5c6">SetStatus</a></div><div class="ttdeci">void SetStatus(DWORD dwState)</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00210">windows/APIService.cpp:210</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a73ef58614ecdba2e246b3dbf3438f169"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a73ef58614ecdba2e246b3dbf3438f169">SERVICENAME</a></div><div class="ttdeci">#define SERVICENAME</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00043">windows/APIService.cpp:43</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a741fe6889f4c295e746bd22110ce1a4c"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4c">ServiceStateType</a></div><div class="ttdeci">ServiceStateType</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00055">windows/APIService.cpp:55</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a741fe6889f4c295e746bd22110ce1a4ca39c75059f37cc59c3a334424b03e3255"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4ca39c75059f37cc59c3a334424b03e3255">uninstalled_state</a></div><div class="ttdeci">@ uninstalled_state</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00055">windows/APIService.cpp:55</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a741fe6889f4c295e746bd22110ce1a4ca3c06b409a56950df36953bbafccae019"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4ca3c06b409a56950df36953bbafccae019">running_state</a></div><div class="ttdeci">@ running_state</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00055">windows/APIService.cpp:55</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a741fe6889f4c295e746bd22110ce1a4ca6c794638ad6911b18c88b63c66644ccb"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4ca6c794638ad6911b18c88b63c66644ccb">installed_state</a></div><div class="ttdeci">@ installed_state</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00055">windows/APIService.cpp:55</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a741fe6889f4c295e746bd22110ce1a4cac5eb4b9150dfb16b4c3d23108a896f5e"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a741fe6889f4c295e746bd22110ce1a4cac5eb4b9150dfb16b4c3d23108a896f5e">disabled_state</a></div><div class="ttdeci">@ disabled_state</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00055">windows/APIService.cpp:55</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a760469f363ac78dbda04c9da73fe3224"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a760469f363ac78dbda04c9da73fe3224">APP_LOG_KEYNAME</a></div><div class="ttdeci">#define APP_LOG_KEYNAME</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00053">windows/APIService.cpp:53</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a7a0190d9005c22d5b7e4677bf336669e"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a7a0190d9005c22d5b7e4677bf336669e">Run</a></div><div class="ttdeci">void Run(bool asService)</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00150">windows/APIService.cpp:150</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a7d84071db7709283ccb4bbee75b7e7a9"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a7d84071db7709283ccb4bbee75b7e7a9">OnPause</a></div><div class="ttdeci">void OnPause()</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00185">windows/APIService.cpp:185</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a7f7a03f7a4079cb2ac53eb684da29533"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a7f7a03f7a4079cb2ac53eb684da29533">Uninstall</a></div><div class="ttdeci">bool Uninstall()</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00618">windows/APIService.cpp:618</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a841b09ebff913cd97433d7d0a34ab478"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a841b09ebff913cd97433d7d0a34ab478">serviceIsRunning</a></div><div class="ttdeci">bool serviceIsRunning(SC_HANDLE hService)</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00674">windows/APIService.cpp:674</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_a9d2fd619d19d31b6390ee3e6bbc1afcc"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#a9d2fd619d19d31b6390ee3e6bbc1afcc">ServiceMain</a></div><div class="ttdeci">static void WINAPI ServiceMain(DWORD dwArgc, LPTSTR *lpszArgv)</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00287">windows/APIService.cpp:287</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_aa632f0b3197adeb7777ee5d14a2ac639"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#aa632f0b3197adeb7777ee5d14a2ac639">OnInit</a></div><div class="ttdeci">bool OnInit()</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00168">windows/APIService.cpp:168</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_aacbfbc2b764a35fa79e6d1ddfea69bba"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#aacbfbc2b764a35fa79e6d1ddfea69bba">OnInterrogate</a></div><div class="ttdeci">void OnInterrogate()</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00180">windows/APIService.cpp:180</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_ab1886bb8bc1d06dde55786719318c1f8"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#ab1886bb8bc1d06dde55786719318c1f8">stopTheService</a></div><div class="ttdeci">bool stopTheService(SC_HANDLE hService, DWORD timeOut)</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00366">windows/APIService.cpp:366</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_abae38490a0892e0d880cf72efb4e0378"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#abae38490a0892e0d880cf72efb4e0378">Info</a></div><div class="ttdeci">static SERVICE_DESCRIPTION Info</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00064">windows/APIService.cpp:64</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_ac7c596526f9e0fd9e9adbf618e2bf815"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#ac7c596526f9e0fd9e9adbf618e2bf815">WindowsVersionType</a></div><div class="ttdeci">WindowsVersionType</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00056">windows/APIService.cpp:56</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_ac7c596526f9e0fd9e9adbf618e2bf815a71176e3a910ac13880a59b1628147ff6"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#ac7c596526f9e0fd9e9adbf618e2bf815a71176e3a910ac13880a59b1628147ff6">Windows_2K</a></div><div class="ttdeci">@ Windows_2K</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00056">windows/APIService.cpp:56</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_ac7c596526f9e0fd9e9adbf618e2bf815acb9da7f09e73b1a6eed5000606d2c5bd"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#ac7c596526f9e0fd9e9adbf618e2bf815acb9da7f09e73b1a6eed5000606d2c5bd">Windows_NT</a></div><div class="ttdeci">@ Windows_NT</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00056">windows/APIService.cpp:56</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_ac996592006c7fb836030f7bf754ff0b4"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#ac996592006c7fb836030f7bf754ff0b4">processCmdLine</a></div><div class="ttdeci">void processCmdLine(const char *cmdLine)</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00875">windows/APIService.cpp:875</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_acb0f1321940d926d618ec2b3af70403e"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#acb0f1321940d926d618ec2b3af70403e">WINDOWS_95_98_ME</a></div><div class="ttdeci">#define WINDOWS_95_98_ME</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00113">windows/APIService.cpp:113</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_acc4c2144e8760df20ff973dff7dbae8d"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#acc4c2144e8760df20ff973dff7dbae8d">Handler</a></div><div class="ttdeci">static void __cdecl Handler(DWORD dwOpcode)</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00223">windows/APIService.cpp:223</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_ad281533a525c10171eb5c0151f5b07b8"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#ad281533a525c10171eb5c0151f5b07b8">SYNTAX_HELP</a></div><div class="ttdeci">#define SYNTAX_HELP</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00046">windows/APIService.cpp:46</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_ad671a71077cbdd09d1c7d2379d5a0ef7"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#ad671a71077cbdd09d1c7d2379d5a0ef7">OnStop</a></div><div class="ttdeci">void OnStop()</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00174">windows/APIService.cpp:174</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_add3df505ce5aac8c66a06f0e74c36bec"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#add3df505ce5aac8c66a06f0e74c36bec">Install</a></div><div class="ttdeci">bool Install()</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00522">windows/APIService.cpp:522</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_aebee0c998e0babaa2e0ae259b22a9f0f"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#aebee0c998e0babaa2e0ae259b22a9f0f">showMessage</a></div><div class="ttdeci">void showMessage(const char *msg, unsigned int icon)</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00108">windows/APIService.cpp:108</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_aee50b830b6eba5b46093d05381d9e898"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#aee50b830b6eba5b46093d05381d9e898">isAtLeastVersion</a></div><div class="ttdeci">bool isAtLeastVersion(WindowsVersionType type)</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00115">windows/APIService.cpp:115</a></div></div>
<div class="ttc" id="awindows_2_a_p_i_service_8cpp_html_afd6369e26b6811ece83b5818ace1b572"><div class="ttname"><a href="windows_2_a_p_i_service_8cpp.html#afd6369e26b6811ece83b5818ace1b572">apiServer</a></div><div class="ttdeci">APIServer apiServer</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_a_p_i_service_8cpp_source.html#l00105">windows/APIService.cpp:105</a></div></div>
<div class="ttc" id="awindows_2_misc_system_8cpp_html_a0433fb1c906371af070782c15cb8e86a"><div class="ttname"><a href="windows_2_misc_system_8cpp.html#a0433fb1c906371af070782c15cb8e86a">version_info</a></div><div class="ttdeci">static OSVERSIONINFO version_info</div><div class="ttdef"><b>Definition:</b> <a href="windows_2_misc_system_8cpp_source.html#l00062">windows/MiscSystem.cpp:62</a></div></div>
<div class="ttc" id="awindows_2rexxapitypes_8h_html_a435d1572bf3f880d55459d9805097f62"><div class="ttname"><a href="windows_2rexxapitypes_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a></div><div class="ttdeci">unsigned int uint32_t</div><div class="ttdef"><b>Definition:</b> <a href="windows_2rexxapitypes_8h_source.html#l00073">windows/rexxapitypes.h:73</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_2b8d323c7289fed1299e6f1b6909d41b.html">oorexx</a></li><li class="navelem"><a class="el" href="dir_8b29bd360d363874c010699c0e4edfe4.html">executor</a></li><li class="navelem"><a class="el" href="dir_b12c9cdd073ecc75d378afe044a8807c.html">sandbox</a></li><li class="navelem"><a class="el" href="dir_6f8e204b311fad1e21be914fb6af8fc9.html">jlf</a></li><li class="navelem"><a class="el" href="dir_4796bfee7d29ff8f3ba63e631cf48035.html">trunk</a></li><li class="navelem"><a class="el" href="dir_d68ff9bd086ab418430d56b10fffff18.html">rexxapi</a></li><li class="navelem"><a class="el" href="dir_32ce186b83d8d79936a4f8258ed759d6.html">server</a></li><li class="navelem"><a class="el" href="dir_13cb2cbdce732fc584953b347d2f47e5.html">platform</a></li><li class="navelem"><a class="el" href="dir_6dabf265a1b6f5f76d4521f905ab827e.html">windows</a></li><li class="navelem"><a class="el" href="windows_2_a_p_i_service_8cpp.html">APIService.cpp</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
<!-- javascript code to insert the title in the condensed index (tabs) -->
<!-- See the function initMenu in menu.js:
     The condensed index is a list <ul> of several items <li>: Main Page, Classes, Files.
     I append a new item <li> which display the project name. -->
<script type="text/javascript">
$(function() {
  $('#main-menu').append('<li class="title" style="margin-left:3mm">executor.master</li>')
});
</script>
<!-- end of javascript code -->
</body>
</html>
